<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.12.9/babel.min.js"></script>
    <link
      rel="stylesheet"
      href="https://site-assets.fontawesome.com/releases/v6.6.0/css/all.css"
    />
    <link rel="stylesheet" href="index.css" />
    <title>Smart Home Manager - Dashboard</title>
  </head>
  <body>
    <div class="sidebar"></div>
    <div id="main">
      <h1>Your Devices</h1>
      <div id="app"></div>
    </div>

    <script type="text/babel">
      const _devices = [];

      function organizeData(data) {
        if (Object.keys(data).length === 0) {
          return {};
        }
        // create a dictionary, where the key is the device type and the value is a list of dictionaries of the devices
        const organizedData = data.reduce((acc, device) => {
          if (!acc[device.type]) {
            acc[device.type] = [];
          }
          acc[device.type].push(device);
          return acc;
        }, {});
        return organizedData;
      }

      function Sidebar() {
        function changeScreen(page) {
          currentPage = page;
          rerender();
        }
        function toggleActive() {
          document.querySelector(".sidebar").classList.toggle("active");
        }

        return (
          <>
            <div className="top">
              <div className="logo">
                <span>Smart Home Manager</span>
              </div>
              <i
                className="fa-regular fa-bars"
                id="btn"
                onClick={toggleActive}
              ></i>
            </div>
            <ul>
              <li>
                <a href="#" onClick={() => changeScreen(0)}>
                  <i className="fa-regular fa-house"></i>
                  <span className="nav-item">Dashboard</span>
                  <span className="tooltip">Dashboard</span>
                </a>
              </li>
              <li>
                <a href="#" onClick={() => changeScreen(1)}>
                  <i className="fa-regular fa-gear"></i>
                  <span className="nav-item">Settings</span>
                  <span className="tooltip">Settings</span>
                </a>
              </li>
              <li>
                <a href="#" onClick={() => changeScreen(2)}>
                  <i className="fa-regular fa-info"></i>
                  <span className="nav-item">Server Info</span>
                  <span className="tooltip">Server Info</span>
                </a>
              </li>
              <li>
                <a href="#" onClick={() => changeScreen(3)}>
                  <i className="fa-regular fa-cloud-arrow-up"></i>
                  <span className="nav-item">Add A Device</span>
                  <span className="tooltip">Add A Device</span>
                </a>
              </li>
              <li>
                <a href="#">
                  <i className="fa-regular fa-gear"></i>
                  <span className="nav-item">Dashboard</span>
                  <span className="tooltip">Dashboard</span>
                </a>
              </li>
              <li>
                <a href="#">
                  <i className="fa-regular fa-gear"></i>
                  <span className="nav-item">Dashboard</span>
                  <span className="tooltip">Dashboard</span>
                </a>
              </li>
            </ul>
          </>
        );
      }

      function FindNewDevice() {
        const [deviceFound, setDeviceFound] = React.useState(false);

        function sendCredentials() {
          loc = document.querySelector("input[name=location]").value;
          fetch("/api/credential-apply", {
            method: "POST",
            body: JSON.stringify({
              location: loc,
            }),
          }).then((res) => {
            if (res.status === 200) {
              alert("Device added successfully!");
            } else {
              alert("An error occurred while adding the device");
            }
          });
        }

        React.useEffect(() => {
          const interval = setInterval(() => {
            fetch("/api/network")
              .then((res) => res.json())
              .then((data) => {
                if (data[0] === true) {
                  setDeviceFound(true);
                }
              });
          }, 1000);
          return () => clearInterval(interval);
        }, []);
        return (
          <>
            {deviceFound && (
              <>
                <h1>Device Found!</h1>
                <label htmlFor="location">Device Location</label>
                <br />
                <input
                  type="text"
                  className="inp"
                  name="location"
                  placeholder="Office, Kitchen, Dining Room 1"
                ></input>
                <br />
                <button className="op-btn" onClick={() => sendCredentials()}>Finish Setup</button>
              </>
            )}
            {deviceFound === false && (
              <>
                <p>
                  Scanning for devices...
                </p>
                <p> If you have a device to add, please turn it on now.</p>
              </>
            )}
          </>
        );
      }

      // create 5 fake devices that have a location, status, and device type (set all to "blind")
      function DeviceWidgets() {
        const [devices, setDevices] = React.useState(organizeData(_devices));
        const [device_found, setDeviceFound] = React.useState(false);
        // create the same setinterval function to fetch the updates
        React.useEffect(() => {
          //Implementing the setInterval method
          const interval = setInterval(() => {
            fetch("/api/updates")
              .then((res) => res.json())
              .then((data) => {
                console.log(device_found);
                console.log(organizeData(data));
                setDevices(organizeData(data));
              })
              .catch((error) => {
                // mostly dev purposes but also incase the fetch fails
                var organized = organizeData(_devices);
                setDevices(() => {
                  organized.blind = organized.blind.map((device) => ({
                    ...device,
                    status: Math.random() > 0.5 ? "open" : "closed",
                  }));
                  return organized;
                });
              });
          }, 5000);
          //Clearing the interval
          return () => clearInterval(interval);
        }, []);
        // create a function that can fetch a device operation

        function fetchOperation(id, operation) {
          fetch(`/api/operation/${id}/${operation}`)
            .then((res) => res.json())
            .then((data) => {
              console.log(data);
              setDevices(data);
            });
        }

        return (
          <React.Fragment>
            {(Object.keys(devices).length === 0 || device_found) && (
              <p>No devices yet. Check the instructions on how to add one!</p>
            )}
            {Object.keys(devices).length > 0 && !device_found && (
              <React.Fragment>
                <h3 className="category-title">Blinds</h3>
                <div className="devices">
                  {devices.blind.map((device) => (
                    <div key={device.location} className="device">
                      <h3>{device.location}</h3>
                      <p>Device status: {device.status}</p>
                      <div className="sp">
                        <button
                          className="op-btn"
                          onClick={() => fetchOperation(device.id, "open")}
                        >
                          <i className="fa-solid fa-blinds-open"></i>
                          Open
                        </button>
                        <button
                          className="op-btn"
                          onClick={() => fetchOperation(device.id, "close")}
                        >
                          <i className="fa-solid fa-blinds"></i>
                          Close
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
                <h3 className="category-title">Cameras</h3>
                <div className="devices">
                  {devices.camera !== undefined && (
                    <>
                      {devices.camera.map((device) => (
                        <div key={device.location} className="device">
                          <h3>{device.location}</h3>
                          <button className="op-btn">
                            <i className="fa-solid fa-video"></i>
                            View Stream
                          </button>
                        </div>
                      ))}
                    </>
                  )}
                </div>
              </React.Fragment>
            )}
          </React.Fragment>
        );
      }
      var currentPage = 0;

      function rerender() {
        // delete any elements in the app div
        ReactDOM.unmountComponentAtNode(document.getElementById("app"));
        if (currentPage === 0) {
          ReactDOM.render(<DeviceWidgets />, document.getElementById("app"));
        } else if (currentPage === 3) {
          ReactDOM.render(<FindNewDevice />, document.getElementById("app"));
        }

        ReactDOM.render(<Sidebar />, document.querySelector(".sidebar"));
      }
      rerender();
    </script>
  </body>
</html>
